#!/usr/bin/make -f

export DH_VERBOSE = 1
export DEB_BUILD_MAINT_OPTIONS = hardening=+all

%:
	dh $@

override_dh_auto_configure:
	dh_auto_configure -- \
		-DCMAKE_BUILD_TYPE=Release \
		-DCMAKE_INSTALL_PREFIX=/usr \
		-DCMAKE_INSTALL_SYSCONFDIR=/etc \
		-DCMAKE_INSTALL_LOCALSTATEDIR=/var

override_dh_auto_install:
	dh_auto_install
	
	# Create necessary directories
	mkdir -p debian/simple-sftpd/etc/simple-sftpd/deployment
	mkdir -p debian/simple-sftpd/etc/simple-sftpd/deployment/sites-available
	mkdir -p debian/simple-sftpd/etc/simple-sftpd/deployment/sites-enabled
	mkdir -p debian/simple-sftpd/etc/simple-sftpd/deployment/modules-available
	mkdir -p debian/simple-sftpd/etc/simple-sftpd/deployment/modules-enabled
	mkdir -p debian/simple-sftpd/etc/simple-sftpd/deployment/conf.d
	mkdir -p debian/simple-sftpd/var/log/simple-sftpd
	mkdir -p debian/simple-sftpd/var/lib/simple-sftpd
	mkdir -p debian/simple-sftpd/var/run/simple-sftpd
	mkdir -p debian/simple-sftpd/var/ftp
	mkdir -p debian/simple-sftpd/etc/systemd/system
	mkdir -p debian/simple-sftpd/etc/init.d
	mkdir -p debian/simple-sftpd/etc/logrotate.d
	
	# Install configuration files
	cp -r ../deployment/* debian/simple-sftpd/etc/simple-sftpd/deployment/
	
	# Install service files
	cp ../etc/systemd/simple-sftpd.service debian/simple-sftpd/etc/systemd/system/
	cp ../etc/systemd/simple-sftpd@.service debian/simple-sftpd/etc/systemd/system/
	cp ../etc/systemd/simple-sftpd.target debian/simple-sftpd/etc/systemd/system/
	
	# Install init scripts
	cp ../etc/init.d/simple-sftpd debian/simple-sftpd/etc/init.d/
	chmod 755 debian/simple-sftpd/etc/init.d/simple-sftpd
	
	# Install logrotate configuration
	cp ../etc/logrotate.d/simple-sftpd debian/simple-sftpd/etc/logrotate.d/
	
	# Install management scripts
	cp ../deployment/simple-sftpd-site debian/simple-sftpd/usr/bin/
	cp ../deployment/simple-sftpd-module debian/simple-sftpd/usr/bin/
	chmod 755 debian/simple-sftpd/usr/bin/simple-sftpd-site
	chmod 755 debian/simple-sftpd/usr/bin/simple-sftpd-module

override_dh_fixperms:
	dh_fixperms
	chmod 755 debian/simple-sftpd/var/ftp
	chmod 755 debian/simple-sftpd/var/log/simple-sftpd
	chmod 755 debian/simple-sftpd/var/lib/simple-sftpd

override_dh_installdocs:
	dh_installdocs
	# Copy documentation
	cp -r ../docs debian/simple-sftpd-doc/usr/share/doc/simple-sftpd/

override_dh_installchangelogs:
	dh_installchangelogs

override_dh_perl:
	# No Perl scripts

override_dh_python3:
	# No Python scripts

override_dh_auto_test:
	# Run tests if available
	# dh_auto_test

override_dh_strip:
	dh_strip --dbg-package=simple-sftpd-dbg

override_dh_shlibdeps:
	dh_shlibdeps

override_dh_gencontrol:
	dh_gencontrol

override_dh_builddeb:
	dh_builddeb
